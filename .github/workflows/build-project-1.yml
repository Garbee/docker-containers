name: Build Project 1

on:
  workflow_dispatch:
  schedule:
    # Run at 3:17 AM UTC every Sunday
    - cron: "17 3 * * 0"
  push:
    branches:
      - main
    paths:
      - "Dockerfile"
      - ".github/workflows/build-project-1.yml"

permissions:
  # Global permissions for the workflow, which can be overridden at the job level
  contents: read

concurrency:
  # This concurrency group ensures that only one job in the group runs at a time.
  # If a new job is triggered, the previous one will be canceled.
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: project-1
  GHCR_IMAGE: ghcr.io/garbee/project-1

jobs:
  versions:
    name: Get Latest Tool versions
    runs-on: ubuntu-slim
    outputs:
      gradle: ${{ steps.get-versions.outputs.gradle }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Install Skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo
      - name: Get latest versions
        id: get-versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: ./bin/get-latest-tool-versions.sh
  # The build job builds the Docker image for each platform specified in the matrix.
  build:
    needs:
      - versions

    permissions:
      contents: read # Ability to clone the repository.
      packages: write # Ability to publish packages to GHCR.

    strategy:
      fail-fast: false
      matrix:
        node-version:
          - 20
          - 22
          - 24
        platform:
          - linux/amd64
          - linux/arm64
        include:
          - platform: linux/amd64
            runner: ubuntu-24.04
            platform_pair: linux-amd64
          - platform: linux/arm64
            runner: ubuntu-24.04-arm
            platform_pair: linux-arm64

    runs-on: ${{ matrix.runner }}
    # The job runs on different runners based on the platform.
    # For linux/amd64, it runs on the latest Ubuntu runner.
    # For linux/arm64, it runs on an Ubuntu 24.04 ARM runner.
    # The runner is selected based on the platform specified in the matrix.

    name: Build for ${{ matrix.platform }} (Node ${{ matrix.node-version }})

    env:
      NODE_SUFFIX: -node${{ matrix.node-version }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
        with:
          cache-binary: false
          platforms: ${{ matrix.platform }}

      - name: Extract Docker Metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.GHCR_IMAGE }}

      - name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        with:
          platforms: ${{ matrix.platform }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          outputs: type=image,name=${{ env.GHCR_IMAGE }},push-by-digest=true,name-canonical=true,push=true
          build-args: |
            NODE_VERSION=${{ matrix.node-version }}
            GRADLE_VERSION=${{ needs.versions.outputs.gradle }}

      - name: Export digest
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          mkdir -p "/${RUNNER_TEMP}/digests"
          digest="${DIGEST}"
          touch "/${RUNNER_TEMP}/digests/${digest#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: digests-${{ matrix.platform_pair }}${{ env.NODE_SUFFIX }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: error
          retention-days: 1

  merge:
    # This job merges the Docker manifests for the different platforms built in the previous job.
    name: Merge Docker manifests (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest

    permissions:
      contents: read # Ability to clone the repository.
      packages: write # Ability to publish packages to GHCR.

    strategy:
      fail-fast: false
      matrix:
        node-version:
          - 20
          - 22
          - 24

    needs:
      - build

    env:
      NODE_SUFFIX: -node${{ matrix.node-version }}

    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Download digests
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*${{ env.NODE_SUFFIX }}
          merge-multiple: true

      - name: Generate Docker tag
        id: tag_info
        env:
          EVENT_NAME: ${{ github.event_name }}
          SHA: ${{ github.sha }}
          RUN_NUMBER: ${{ github.run_number }}
          RUN_ATTEMPT: ${{ github.run_attempt }}
          NODE_SUFFIX: ${{ env.NODE_SUFFIX }}
        run: |
          YEAR_WEEK=$(date -u +"%Y-W%V")

          case "$EVENT_NAME" in
            schedule)
              RUN_TYPE="scheduled"
              UNIQUE="${RUN_NUMBER}-${RUN_ATTEMPT}"
              ;;
            push)
              RUN_TYPE="push"
              UNIQUE="${SHA:0:7}"
              ;;
            workflow_dispatch)
              RUN_TYPE="manual"
              UNIQUE="${RUN_NUMBER}-${RUN_ATTEMPT}-$(date -u +"%H%M%S")"
              ;;
            *)
              RUN_TYPE="$EVENT_NAME"
              UNIQUE="${RUN_NUMBER}-${RUN_ATTEMPT}"
              ;;
          esac

          TAG="${YEAR_WEEK}-${RUN_TYPE}-${UNIQUE}${NODE_SUFFIX}"

          echo "Docker Tag: $TAG"
          echo "TAG=$TAG" >> "$GITHUB_OUTPUT"

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5.10.0
        with:
          images: ${{ env.GHCR_IMAGE }}
          annotations: |
            type=org.opencontainers.image.description,value=Development container with Node.js, Java, Gradle, Python, and browser testing tools
            type=org.opencontainers.licenses,value=CC-PDM-1.0
            type=org.opencontainers.image.url,value=https://github.com/garbee/docker-containers
          tags: |
            type=raw,value=main${{ env.NODE_SUFFIX }},enable=${{ github.ref_name == 'main' }}
            type=raw,value=latest,enable=${{ github.ref_name == 'main' && matrix.node-version == '22' }}
            type=raw,value=${{ steps.tag_info.outputs.TAG }}
            type=raw,value=on:manual${{ env.NODE_SUFFIX }},enable=${{ github.event_name == 'workflow_dispatch' }}
            type=raw,value=on:scheduled${{ env.NODE_SUFFIX }},enable=${{ github.event_name == 'schedule' }}
            type=raw,value=on:push${{ env.NODE_SUFFIX }},enable=${{ github.event_name == 'push' }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
        with:
          cache-binary: false

      - name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        # This step logs in to the GitHub Container Registry (GHCR) using the docker/login-action.
        # It uses the GitHub actor's username and the GITHUB_TOKEN secret for authentication.
        # The login is necessary to push the merged manifest list to GHCR.
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Debug
        run: ls -lRha "${{ runner.temp }}/digests"

      - name: Create manifest list and pushes
        id: manifest-annotate
        continue-on-error: false
        env:
          NODE_VERSION: ${{ matrix.node-version }}
          DIGEST_PATH: ${{ runner.temp }}/digests
        run: ./bin/create-manifests-and-push.sh

      - name: Inspect image
        id: inspect
        env:
          IMAGE: "${{ env.GHCR_IMAGE }}:${{ steps.meta.outputs.version }}"
        run: docker buildx imagetools inspect "$IMAGE"

      - name: Delete Artifacts
        uses: geekyeggo/delete-artifact@f275313e70c08f6120db482d7a6b98377786765b # v5.1.0
        if: always()
        with:
          name: |
            digests-*${{ env.NODE_SUFFIX }}
